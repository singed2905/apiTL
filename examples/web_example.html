<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ConvertKeylogApp Geometry API - Web Demo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #333; min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); overflow: hidden; }
        .header { background: linear-gradient(45deg, #4CAF50, #2196F3); color: white; padding: 30px; text-align: center; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .header p { font-size: 1.1em; opacity: 0.9; }
        .main-content { padding: 30px; display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .form-section { background: #f8f9fa; border-radius: 10px; padding: 25px; border: 2px solid #e9ecef; }
        .form-section h3 { color: #495057; margin-bottom: 20px; font-size: 1.3em; border-bottom: 2px solid #4CAF50; padding-bottom: 10px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #495057; }
        .form-group select, .form-group input { width: 100%; padding: 12px; border: 2px solid #dee2e6; border-radius: 6px; font-size: 14px; transition: border-color 0.3s; }
        .form-group select:focus, .form-group input:focus { outline: none; border-color: #4CAF50; box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1); }
        .btn { background: linear-gradient(45deg, #4CAF50, #45a049); color: white; border: none; padding: 15px 30px; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 600; transition: transform 0.2s, box-shadow 0.2s; width: 100%; margin-top: 10px; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3); }
        .btn:disabled { background: #6c757d; cursor: not-allowed; transform: none; box-shadow: none; }
        .results-section { background: #fff; border-radius: 10px; padding: 25px; border: 2px solid #e9ecef; }
        .result-item { background: #f8f9fa; border-left: 4px solid #4CAF50; padding: 15px; margin-bottom: 15px; border-radius: 0 6px 6px 0; }
        .result-item h4 { color: #495057; margin-bottom: 8px; }
        .keylog { background: #2c3e50; color: #ecf0f1; padding: 15px; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 16px; word-break: break-all; position: relative; }
        .copy-btn { position: absolute; top: 10px; right: 10px; background: #3498db; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; padding: 15px; border-radius: 6px; margin-bottom: 15px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; padding: 15px; border-radius: 6px; margin-bottom: 15px; }
        .loading { text-align: center; padding: 20px; color: #6c757d; }
        .shape-inputs { display: none; margin-top: 15px; padding: 15px; background: #ffffff; border-radius: 6px; border: 1px solid #dee2e6; }
        .shape-inputs.active { display: block; }
        .examples-section { grid-column: 1 / -1; background: #e8f5e8; border-radius: 10px; padding: 25px; margin-top: 20px; }
        .example-btn { background: #17a2b8; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin: 5px; font-size: 14px; }
        .example-btn:hover { background: #138496; }
        .excel-section { background: #f8f9fa; border-radius: 10px; padding: 25px; border: 2px solid #e9ecef; margin-top: 20px; grid-column: 1 / -1; }
        .upload-zone { border: 2px dashed #4CAF50; border-radius: 10px; padding: 40px; text-align: center; cursor: pointer; transition: background-color 0.3s; }
        .upload-zone:hover { background-color: #f0f8f0; }
        .upload-icon { font-size: 3em; margin-bottom: 10px; }
        .file-info { background: white; padding: 20px; border-radius: 8px; margin: 20px 0; border: 1px solid #dee2e6; }
        .preview-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .preview-table th, .preview-table td { border: 1px solid #dee2e6; padding: 8px; text-align: left; }
        .preview-table th { background-color: #f8f9fa; font-weight: 600; }
        .progress-section { background: white; padding: 20px; border-radius: 8px; margin: 20px 0; }
        .progress-bar { width: 100%; height: 20px; background-color: #e9ecef; border-radius: 10px; overflow: hidden; margin: 10px 0; }
        .progress-fill { height: 100%; background: linear-gradient(45deg, #4CAF50, #45a049); width: 0%; transition: width 0.3s ease; }
        .batch-results { background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; padding: 20px; margin: 20px 0; }
        .validation-summary { background: #fff; border: 1px dashed #4CAF50; padding: 15px; border-radius: 8px; margin-top: 10px; }
        .validation-error { background: #fdecea; color: #d93025; padding: 10px; border-radius: 6px; margin-bottom: 10px; }
        .validation-success { background: #e6f4ea; color: #137333; padding: 10px; border-radius: 6px; margin-bottom: 10px; }
        .detected-columns { margin-top: 10px; }
        .column-list { font-family: monospace; font-size: 12px; background: #f8f9fa; padding: 8px; border-radius: 6px; }
        @media (max-width: 768px) { .main-content { grid-template-columns: 1fr; } .header h1 { font-size: 1.8em; } }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üßÆ ConvertKeylogApp Geometry API</h1>
        <p>Web Demo - Chuy·ªÉn ƒë·ªïi b√†i to√°n h√¨nh h·ªçc th√†nh keylog m√°y t√≠nh Casio</p>
    </div>

    <div class="main-content">
        <div class="form-section">
            <h3>üìù Nh·∫≠p d·ªØ li·ªáu</h3>
            <div class="form-group">
                <label for="operation">Ph√©p to√°n:</label>
                <select id="operation" onchange="updateShapeOptions()">
                    <option value="">Ch·ªçn ph√©p to√°n...</option>
                </select>
            </div>
            <div class="form-group">
                <label for="shapeA">H√¨nh A:</label>
                <select id="shapeA" onchange="updateInputFields()">
                    <option value="">Ch·ªçn h√¨nh A...</option>
                </select>
            </div>
            <div id="inputsA" class="shape-inputs"></div>
            <div class="form-group">
                <label for="shapeB">H√¨nh B (t√πy ch·ªçn):</label>
                <select id="shapeB" onchange="updateInputFields()">
                    <option value="">Kh√¥ng c√≥</option>
                </select>
            </div>
            <div id="inputsB" class="shape-inputs"></div>
            <div class="form-group">
                <label for="version">Phi√™n b·∫£n m√°y t√≠nh:</label>
                <select id="version">
                    <option value="fx799">Casio fx-799</option>
                    <option value="fx800">Casio fx-800</option>
                    <option value="fx801">Casio fx-801</option>
                    <option value="fx802">Casio fx-802</option>
                    <option value="fx803">Casio fx-803</option>
                </select>
            </div>
            <button class="btn" onclick="processGeometry()" id="processBtn">üöÄ T√≠nh to√°n</button>
        </div>

        <div class="results-section">
            <h3>üìä K·∫øt qu·∫£</h3>
            <div id="results"><div class="loading">Nh·∫≠p d·ªØ li·ªáu v√† nh·∫•n "T√≠nh to√°n" ƒë·ªÉ xem k·∫øt qu·∫£...</div></div>
            <div id="validationResults"></div>
        </div>

        <div class="examples-section">
            <h3>üí° V√≠ d·ª• nhanh</h3>
            <p style="margin-bottom: 15px;">Nh·∫•n v√†o m·ªôt v√≠ d·ª• ƒë·ªÉ t·ª± ƒë·ªông ƒëi·ªÅn d·ªØ li·ªáu:</p>
            <button class="example-btn" onclick="loadExample('distance_points')">Kho·∫£ng c√°ch 2 ƒëi·ªÉm</button>
            <button class="example-btn" onclick="loadExample('circle_area')">Di·ªán t√≠ch ƒë∆∞·ªùng tr√≤n</button>
            <button class="example-btn" onclick="loadExample('sphere_volume')">Th·ªÉ t√≠ch m·∫∑t c·∫ßu</button>
            <button class="example-btn" onclick="loadExample('line_plane_intersection')">Giao tuy·∫øn ƒë∆∞·ªùng th·∫≥ng - m·∫∑t ph·∫≥ng</button>
        </div>

        <div class="excel-section">
            <h3>üìä Excel Batch Processing (Frontend)</h3>
            <div class="upload-area" id="uploadArea">
                <input type="file" id="excelFile" accept=".xlsx,.xls" style="display: none;" onchange="handleExcelLocal()">
                <div class="upload-zone" onclick="document.getElementById('excelFile').click()">
                    <div class="upload-icon">üìÅ</div>
                    <p>Ch·ªçn file Excel ƒë·ªÉ ƒë·ªçc tr·ª±c ti·∫øp tr√™n tr√¨nh duy·ªát</p>
                    <small>FE s·∫Ω parse & validate, BE ch·ªâ x·ª≠ l√Ω JSON</small>
                </div>
            </div>
            <div id="fileInfo" class="file-info" style="display: none;">
                <h4>üìã Th√¥ng tin file:</h4>
                <div id="fileDetails"></div>
                <div id="previewTable"></div>
            </div>
            <div id="processingConfig" class="processing-config" style="display: none;">
                <div class="form-group">
                    <label>Ph√©p to√°n cho batch:</label>
                    <select id="batchOperation"></select>
                </div>
                <div class="form-group">
                    <label>H√¨nh A:</label>
                    <select id="batchShapeA"></select>
                </div>
                <div class="form-group">
                    <label>H√¨nh B:</label>
                    <select id="batchShapeB"></select>
                </div>
                <button class="btn" onclick="processBatchFE()" id="processBatchBtn" disabled>üöÄ X·ª≠ l√Ω Batch</button>
            </div>
            <div id="batchProgress" class="progress-section" style="display: none;">
                <h4>‚è≥ ƒêang x·ª≠ l√Ω...</h4>
                <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
                <div id="progressText">0%</div>
            </div>
            <div id="batchResults" class="batch-results" style="display: none;">
                <h4>‚úÖ Ho√†n th√†nh!</h4>
                <div id="batchSummary"></div>
            </div>
        </div>
    </div>
</div>

<script>
    const API_BASE = 'http://localhost:5000';
    let availableShapes = [];
    let availableOperations = [];
    let excelJsonData = [];

    const SHAPE_TEMPLATES = {
        'ƒêi·ªÉm': { required_columns: ['point_input'], alternative_columns: [['x','y'], ['x','y','z']], description: 'C·∫ßn point_input ho·∫∑c x,y(,z)' },
        'ƒê∆∞·ªùng th·∫≥ng': { required_columns: ['line_A1','line_X1'], alternative_columns: [['line_point','line_vector']], description: 'C·∫ßn ƒëi·ªÉm v√† vector' },
        'M·∫∑t ph·∫≥ng': { required_columns: ['plane_a','plane_b','plane_c','plane_d'], description: 'C·∫ßn 4 h·ªá s·ªë a,b,c,d' },
        'ƒê∆∞·ªùng tr√≤n': { required_columns: ['circle_center','circle_radius'], alternative_columns: [['center_x','center_y','radius']], description: 'C·∫ßn t√¢m v√† b√°n k√≠nh' },
        'M·∫∑t c·∫ßu': { required_columns: ['sphere_center','sphere_radius'], alternative_columns: [['center_x','center_y','center_z','radius']], description: 'C·∫ßn t√¢m v√† b√°n k√≠nh' }
    };

    async function initApp() {
        try {
            const [shapesRes, operationsRes] = await Promise.all([
                fetch(`${API_BASE}/api/geometry/shapes`),
                fetch(`${API_BASE}/api/geometry/operations`)
            ]);
            const shapesData = await shapesRes.json();
            const operationsData = await operationsRes.json();
            availableShapes = shapesData.data || [];
            availableOperations = operationsData.data || [];
            populateOperations();
            populateShapes();
        } catch (error) { showError('Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn API.'); }
    }

    function populateOperations() {
        const select = document.getElementById('operation');
        select.innerHTML = '<option value="">Ch·ªçn ph√©p to√°n...</option>';
        availableOperations.forEach(op => { const o=document.createElement('option'); o.value=op; o.textContent=op; select.appendChild(o); });
    }

    function populateShapes() {
        const selectA=document.getElementById('shapeA'); const selectB=document.getElementById('shapeB');
        selectA.innerHTML='<option value="">Ch·ªçn h√¨nh A...</option>'; selectB.innerHTML='<option value="">Kh√¥ng c√≥</option>';
        availableShapes.forEach(s=>{ const a=document.createElement('option'); a.value=s; a.textContent=s; selectA.appendChild(a); const b=document.createElement('option'); b.value=s; b.textContent=s; selectB.appendChild(b); });
    }

    async function updateShapeOptions() {
        const operation=document.getElementById('operation').value; if(!operation) return;
        const res=await fetch(`${API_BASE}/api/geometry/operations/${encodeURIComponent(operation)}/shapes`);
        const data=await res.json();
        const selectA=document.getElementById('shapeA'); const selectB=document.getElementById('shapeB');
        selectA.innerHTML='<option value="">Ch·ªçn h√¨nh A...</option>';
        (data.data||[]).forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; selectA.appendChild(o); });
        selectB.innerHTML='<option value="">Kh√¥ng c√≥</option>';
        if(!['Di·ªán t√≠ch','Th·ªÉ t√≠ch'].includes(operation)) { (data.data||[]).forEach(s=>{ const o=document.createElement('option'); o.value=s; o.textContent=s; selectB.appendChild(o); }); }
        updateInputFields();
    }

    function updateInputFields() { const a=document.getElementById('shapeA').value; const b=document.getElementById('shapeB').value; updateShapeInputs('A',a); updateShapeInputs('B',b); }

    function updateShapeInputs(group, shape) {
        const c=document.getElementById(`inputs${group}`); c.innerHTML=''; if(!shape){c.classList.remove('active');return;} c.classList.add('active');
        if(shape==='ƒêi·ªÉm'){ c.innerHTML=`<label>T·ªça ƒë·ªô (x,y,z):</label><input type="text" id="point_input_${group}" placeholder="V√≠ d·ª•: 1,2,3">`; }
        else if(shape==='ƒê∆∞·ªùng th·∫≥ng'){ c.innerHTML=`<label>ƒêi·ªÉm tr√™n ƒë∆∞·ªùng th·∫≥ng (x,y,z):</label><input type="text" id="line_A${group==='A'?'1':'2'}_${group}" placeholder="V√≠ d·ª•: 0,0,0"><label style="margin-top:10px;">Vector ch·ªâ ph∆∞∆°ng (dx,dy,dz):</label><input type="text" id="line_X${group==='A'?'1':'2'}_${group}" placeholder="V√≠ d·ª•: 1,1,1">`; }
        else if(shape==='M·∫∑t ph·∫≥ng'){ c.innerHTML=`<label>H·ªá s·ªë a:</label><input type="text" id="plane_a_${group}" placeholder="1"><label>H·ªá s·ªë b:</label><input type="text" id="plane_b_${group}" placeholder="1"><label>H·ªá s·ªë c:</label><input type="text" id="plane_c_${group}" placeholder="1"><label>H·∫±ng s·ªë d:</label><input type="text" id="plane_d_${group}" placeholder="0">`; }
        else if(shape==='ƒê∆∞·ªùng tr√≤n'){ c.innerHTML=`<label>T√¢m (x,y):</label><input type="text" id="circle_center_${group}" placeholder="0,0"><label style="margin-top:10px;">B√°n k√≠nh:</label><input type="text" id="circle_radius_${group}" placeholder="5">`; }
        else if(shape==='M·∫∑t c·∫ßu'){ c.innerHTML=`<label>T√¢m (x,y,z):</label><input type="text" id="sphere_center_${group}" placeholder="0,0,0"><label style="margin-top:10px;">B√°n k√≠nh:</label><input type="text" id="sphere_radius_${group}" placeholder="3">`; }
    }

    function collectInputData(group, shape) {
        const d={}; if(shape==='ƒêi·ªÉm'){ const v=document.getElementById(`point_input_${group}`); if(v) d.point_input=v.value; }
        else if(shape==='ƒê∆∞·ªùng th·∫≥ng'){ const la=document.getElementById(`line_A${group==='A'?'1':'2'}_${group}`); const lx=document.getElementById(`line_X${group==='A'?'1':'2'}_${group}`); if(la) d[`line_A${group==='A'?'1':'2'}`]=la.value; if(lx) d[`line_X${group==='A'?'1':'2'}`]=lx.value; }
        else if(shape==='M·∫∑t ph·∫≥ng'){ ['a','b','c','d'].forEach(k=>{ const el=document.getElementById(`plane_${k}_${group}`); if(el) d[`plane_${k}`]=el.value; }); }
        else if(shape==='ƒê∆∞·ªùng tr√≤n'){ const cc=document.getElementById(`circle_center_${group}`); const cr=document.getElementById(`circle_radius_${group}`); if(cc) d.circle_center=cc.value; if(cr) d.circle_radius=cr.value; }
        else if(shape==='M·∫∑t c·∫ßu'){ const sc=document.getElementById(`sphere_center_${group}`); const sr=document.getElementById(`sphere_radius_${group}`); if(sc) d.sphere_center=sc.value; if(sr) d.sphere_radius=sr.value; }
        return d;
    }

    async function processGeometry() {
        const operation=document.getElementById('operation').value; const shapeA=document.getElementById('shapeA').value; const shapeB=document.getElementById('shapeB').value; const version=document.getElementById('version').value; if(!operation||!shapeA){ showError('Vui l√≤ng ch·ªçn ph√©p to√°n v√† h√¨nh A.'); return; }
        const dataA=collectInputData('A',shapeA); const dataB=shapeB?collectInputData('B',shapeB):{}; const body={ operation, shape_A:shapeA, data_A:dataA, version }; if(shapeB){ body.shape_B=shapeB; body.data_B=dataB; }
        document.getElementById('results').innerHTML='<div class="loading">üîÑ ƒêang x·ª≠ l√Ω...</div>'; document.getElementById('processBtn').disabled=true;
        try { const res=await fetch(`${API_BASE}/api/geometry/process`,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body)}); const r=await res.json(); if(r.status==='success') displayResults(r.data); else showError(r.message||'X·ª≠ l√Ω th·∫•t b·∫°i'); } catch(e){ showError('L·ªói k·∫øt n·ªëi ƒë·∫øn API: '+e.message); } finally { document.getElementById('processBtn').disabled=false; }
    }

    function displayResults(data) { const el=document.getElementById('results'); el.innerHTML=`<div class="result-item"><h4>üîë Keylog (${data.version}):</h4><div class="keylog">${data.keylog}<button class="copy-btn" onclick="copyToClipboard('${data.keylog}')">Copy</button></div></div><div class="result-item"><h4>üìù Th√¥ng tin:</h4><p><strong>Ph√©p to√°n:</strong> ${data.operation}</p><p><strong>H√¨nh A:</strong> ${data.shape_A}</p>${data.shape_B?`<p><strong>H√¨nh B:</strong> ${data.shape_B}</p>`:''}<p><strong>M√£ h√≥a A:</strong> [${(data.encoded_A||[]).join(', ')}]</p>${(data.encoded_B&&data.encoded_B.length>0)?`<p><strong>M√£ h√≥a B:</strong> [${data.encoded_B.join(', ')}]</p>`:''}</div><div class="success">‚úÖ X·ª≠ l√Ω th√†nh c√¥ng!</div>`; }
    function showError(m){ document.getElementById('results').innerHTML=`<div class="error">‚ùå ${m}</div>`; }
    function copyToClipboard(t){ navigator.clipboard.writeText(t).then(()=>{ const b=event.target; const o=b.textContent; b.textContent='Copied!'; b.style.background='#27ae60'; setTimeout(()=>{ b.textContent=o; b.style.background='#3498db'; },1500); }).catch(()=>alert('Kh√¥ng th·ªÉ copy.')); }

    const examples={ distance_points:{ operation:'Kho·∫£ng c√°ch', shapeA:'ƒêi·ªÉm', shapeB:'ƒêi·ªÉm', dataA:{point_input:'1,2,3'}, dataB:{point_input:'4,5,6'} }, circle_area:{ operation:'Di·ªán t√≠ch', shapeA:'ƒê∆∞·ªùng tr√≤n', dataA:{circle_center:'0,0', circle_radius:'sqrt(5)'} }, sphere_volume:{ operation:'Th·ªÉ t√≠ch', shapeA:'M·∫∑t c·∫ßu', dataA:{ sphere_center:'0,0,0', sphere_radius:'3'} }, line_plane_intersection:{ operation:'T∆∞∆°ng giao', shapeA:'ƒê∆∞·ªùng th·∫≥ng', shapeB:'M·∫∑t ph·∫≥ng', dataA:{ line_A1:'0,0,0', line_X1:'1,1,1' }, dataB:{ plane_a:'1', plane_b:'1', plane_c:'1', plane_d:'0' } } };

    function loadExample(k){ const ex=examples[k]; if(!ex) return; document.getElementById('operation').value=ex.operation; updateShapeOptions().then(()=>{ document.getElementById('shapeA').value=ex.shapeA; if(ex.shapeB){ document.getElementById('shapeB').value=ex.shapeB; } updateInputFields(); setTimeout(()=>{ Object.entries(ex.dataA).forEach(([key,val])=>{ const i=document.getElementById(`${key}_A`); if(i) i.value=val; }); if(ex.dataB){ Object.entries(ex.dataB).forEach(([key,val])=>{ const i=document.getElementById(`${key}_B`); if(i) i.value=val; }); } },100); }); }

    function readExcelFile(file){ return new Promise((resolve,reject)=>{ const reader=new FileReader(); reader.onload=e=>{ try{ const data=new Uint8Array(e.target.result); const wb=XLSX.read(data,{type:'array'}); const ws=wb.Sheets[wb.SheetNames[0]]; const json=XLSX.utils.sheet_to_json(ws,{defval:''}); resolve(json); }catch(err){ reject(err); } }; reader.onerror=reject; reader.readAsArrayBuffer(file); }); }

    function findSimilarColumns(available, missing){ const sim=[]; missing.forEach(m=>{ available.forEach(a=>{ if(a.toLowerCase().includes(m.toLowerCase())||m.toLowerCase().includes(a.toLowerCase())) sim.push(a); }); }); return [...new Set(sim)]; }

    function checkShapeColumns(columns, shape, group){ const res={ errors:[], warnings:[], suggestions:[] }; const t=SHAPE_TEMPLATES[shape]; if(!t){ res.errors.push(`Kh√¥ng h·ªó tr·ª£ shape: ${shape}`); return res; } const missing=t.required_columns.filter(c=>{ const g=`${c}_${group}`; return !columns.includes(c)&&!columns.includes(g); }); if(missing.length>0){ let ok=false; if(t.alternative_columns){ for(const alt of t.alternative_columns){ const found=alt.every(c=> columns.includes(c)||columns.includes(`${c}_${group}`)); if(found){ ok=true; res.suggestions.push(`T√¨m th·∫•y format thay th·∫ø cho ${shape} (${group}): ${alt.join(', ')}`); break; } } } if(!ok){ res.errors.push(`${shape} (${group}) thi·∫øu c·ªôt: ${missing.join(', ')}. ${t.description}`); const similar=findSimilarColumns(columns, missing); if(similar.length>0) res.suggestions.push(`C√≥ th·ªÉ b·∫°n mu·ªën d√πng: ${similar.join(', ')}?`); } }
        return res; }

    function validateExcelStructure(jsonData, operation, shapeA, shapeB){ const out={ valid:true, errors:[], warnings:[], suggestions:[], detected_columns:[] }; if(!jsonData||jsonData.length===0){ out.valid=false; out.errors.push('File Excel tr·ªëng ho·∫∑c kh√¥ng c√≥ d·ªØ li·ªáu'); return out; } const columns=Object.keys(jsonData[0]); out.detected_columns=columns; const va=checkShapeColumns(columns, shapeA, 'A'); out.errors.push(...va.errors); out.warnings.push(...va.warnings); out.suggestions.push(...va.suggestions); if(shapeB && !['Di·ªán t√≠ch','Th·ªÉ t√≠ch'].includes(operation)){ const vb=checkShapeColumns(columns, shapeB, 'B'); out.errors.push(...vb.errors); out.warnings.push(...vb.warnings); out.suggestions.push(...vb.suggestions); } out.valid=out.errors.length===0; return out; }

    function checkDataQuality(json){ const q={ total_rows:json.length, empty_rows:0, incomplete_rows:0, valid_rows:0, issues:[] }; json.forEach((row,idx)=>{ const vals=Object.values(row); const empties=vals.filter(v=>!v||v.toString().trim()==='').length; if(empties===vals.length) q.empty_rows++; else if(empties>0){ q.incomplete_rows++; q.issues.push(`D√≤ng ${idx+1}: Thi·∫øu ${empties} gi√° tr·ªã`); } else q.valid_rows++; }); return q; }

    function displayValidationResults(v){ const c=document.getElementById('validationResults'); let h='<div class="validation-summary">'; h+= v.valid?'<div class="validation-success">‚úÖ File Excel h·ª£p l·ªá!</div>':'<div class="validation-error">‚ùå File Excel c√≥ v·∫•n ƒë·ªÅ</div>'; h+=`<div class="detected-columns"><h5>üìã C√°c c·ªôt:</h5><div class="column-list">${v.detected_columns.join(', ')}</div></div>`; if(v.errors.length>0){ h+='<div class="validation-errors"><h5>üö® L·ªói:</h5><ul>'; v.errors.forEach(e=>h+=`<li>${e}</li>`); h+='</ul></div>'; } if(v.suggestions.length>0){ h+='<div class="validation-suggestions"><h5>üí° G·ª£i √Ω:</h5><ul>'; v.suggestions.forEach(s=>h+=`<li>${s}</li>`); h+='</ul></div>'; } h+='</div>'; c.innerHTML=h; }

    function displayQualityReport(q){ const c=document.getElementById('fileDetails'); c.innerHTML+=`<p><strong>T·ªïng d√≤ng:</strong> ${q.total_rows}</p><p><strong>D√≤ng r·ªóng:</strong> ${q.empty_rows}</p><p><strong>D√≤ng thi·∫øu d·ªØ li·ªáu:</strong> ${q.incomplete_rows}</p><p><strong>D√≤ng h·ª£p l·ªá:</strong> ${q.valid_rows}</p>`; }

    function displayPreview(rows){ const p=document.getElementById('previewTable'); if(!rows||rows.length===0){ p.innerHTML=''; return; } const cols=Object.keys(rows[0]); let html='<h5>Preview (5 d√≤ng ƒë·∫ßu):</h5><table class="preview-table"><thead><tr>'; cols.forEach(c=> html+=`<th>${c}</th>` ); html+='</tr></thead><tbody>'; rows.forEach(r=>{ html+='<tr>'; cols.forEach(c=> html+=`<td>${r[c]??''}</td>` ); html+='</tr>'; }); html+='</tbody></table>'; p.innerHTML=html; }

    async function handleExcelLocal(){ const file=document.getElementById('excelFile').files[0]; if(!file) return; try{ const json=await readExcelFile(file); excelJsonData=json; const opSel=document.getElementById('operation'); const shA=document.getElementById('shapeA'); const shB=document.getElementById('shapeB'); const operation=opSel.value; const shapeA=shA.value; const shapeB=shB.value; document.getElementById('fileInfo').style.display='block'; document.getElementById('processingConfig').style.display='block'; populateBatchConfig(); const validation=validateExcelStructure(json, operation, shapeA, shapeB); const quality=checkDataQuality(json); displayValidationResults(validation); displayQualityReport(quality); displayPreview(json.slice(0,5)); document.getElementById('processBatchBtn').disabled=!validation.valid; } catch(e){ showError('Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c file Excel: '+e.message); } }

    function populateBatchConfig(){ document.getElementById('batchOperation').innerHTML=document.getElementById('operation').innerHTML; document.getElementById('batchShapeA').innerHTML=document.getElementById('shapeA').innerHTML; document.getElementById('batchShapeB').innerHTML=document.getElementById('shapeB').innerHTML; }

    function extractShapeData(row, shape, group){ const d={}; if(!shape) return d; if(shape==='ƒêi·ªÉm'){ if(row[`point_input_${group}`]||row.point_input) d.point_input=(row[`point_input_${group}`]||row.point_input); else if(row.x&&row.y) d.point_input=[row.x,row.y,row.z].filter(Boolean).join(','); }
        else if(shape==='ƒê∆∞·ªùng th·∫≥ng'){ const p=row[`line_A${group==='A'?1:2}_${group}`]||row[`line_A${group==='A'?1:2}`]||row.line_point; const v=row[`line_X${group==='A'?1:2}_${group}`]||row[`line_X${group==='A'?1:2}`]||row.line_vector; if(p) d[`line_A${group==='A'?1:2}`]=p; if(v) d[`line_X${group==='A'?1:2}`]=v; }
        else if(shape==='M·∫∑t ph·∫≥ng'){ ['a','b','c','d'].forEach(k=>{ const v=row[`plane_${k}_${group}`]??row[`plane_${k}`]; if(v!==undefined&&v!=='') d[`plane_${k}`]=v; }); }
        else if(shape==='ƒê∆∞·ªùng tr√≤n'){ const c=row[`circle_center_${group}`]||row.circle_center||([row.center_x,row.center_y].every(v=>v!==undefined)?`${row.center_x},${row.center_y}`:undefined); const r=row[`circle_radius_${group}`]||row.circle_radius||row.radius; if(c) d.circle_center=c; if(r) d.circle_radius=r; }
        else if(shape==='M·∫∑t c·∫ßu'){ const c=row[`sphere_center_${group}`]||row.sphere_center||([row.center_x,row.center_y,row.center_z].every(v=>v!==undefined)?`${row.center_x},${row.center_y},${row.center_z}`:undefined); const r=row[`sphere_radius_${group}`]||row.sphere_radius||row.radius; if(c) d.sphere_center=c; if(r) d.sphere_radius=r; }
        return d; }

    async function processBatchFE(){ const op=document.getElementById('batchOperation').value; const sA=document.getElementById('batchShapeA').value; const sB=document.getElementById('batchShapeB').value; if(!op||!sA||excelJsonData.length===0){ showError('Thi·∫øu d·ªØ li·ªáu batch'); return; }
        const calculations=excelJsonData.map(row=>({ operation:op, shape_A:sA, data_A:extractShapeData(row, sA, 'A'), shape_B:sB||undefined, data_B:sB?extractShapeData(row, sB, 'B'):undefined }));
        document.getElementById('batchProgress').style.display='block'; let p=0; const it=setInterval(()=>{ p=Math.min(90,p+10); updateProgress(p); },400);
        try{ const res=await fetch(`${API_BASE}/api/geometry/batch`,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({calculations}) }); const r=await res.json(); clearInterval(it); updateProgress(100); document.getElementById('batchResults').style.display='block'; const ok=r.data.filter(x=>!!x).length; const err=(r.error_details||[]).length; document.getElementById('batchSummary').innerHTML=`<p><strong>T·ªïng:</strong> ${r.total_processed||calculations.length}</p><p><strong>Th√†nh c√¥ng:</strong> ${ok}</p><p><strong>L·ªói:</strong> ${err}</p>`; exportResultsToExcel(r); } catch(e){ clearInterval(it); showError('Batch l·ªói: '+e.message); }
    }

    function exportResultsToExcel(r){ try{ const rows=[]; for(let i=0;i<excelJsonData.length;i++){ const src=excelJsonData[i]; const item=r.data[i]; rows.push({ ...src, keylog: item && item.keylog ? item.keylog : '' }); } const ws=XLSX.utils.json_to_sheet(rows); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Results'); XLSX.writeFile(wb, 'geometry_results.xlsx'); } catch(e){ console.error('Export error:', e); }
    }

    window.addEventListener('load', initApp);
</script>
</body>
</html>