<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ConvertKeylogApp - Equation Excel Mode Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2E86AB 0%, #A23B72 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border-left: 5px solid #2E86AB;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }
        
        select, input[type="file"], button {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        select:focus, input:focus, button:focus {
            outline: none;
            border-color: #2E86AB;
            box-shadow: 0 0 0 3px rgba(46, 134, 171, 0.1);
        }
        
        button {
            background: linear-gradient(135deg, #2E86AB 0%, #A23B72 100%);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            margin-top: 10px;
            transition: transform 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .results {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .error {
            background: #ffebee;
            border: 1px solid #f44336;
            color: #c62828;
        }
        
        .log {
            background: #f5f5f5;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .download-link {
            display: inline-block;
            background: #4caf50;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            text-decoration: none;
            margin: 10px 5px;
            font-weight: 600;
        }
        
        .download-link:hover {
            background: #45a049;
            text-decoration: none;
        }
        
        .progress {
            width: 100%;
            height: 20px;
            background-color: #ddd;
            border-radius: 10px;
            margin: 10px 0;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #2E86AB, #A23B72);
            border-radius: 10px;
            transition: width 0.3s ease;
            text-align: center;
            line-height: 20px;
            color: white;
            font-size: 12px;
            font-weight: 600;
        }
        
        .file-info {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üßÆ ConvertKeylogApp - Equation Excel Mode</h1>
            <p>Import v√† x·ª≠ l√Ω h·ªá ph∆∞∆°ng tr√¨nh t·ª´ file Excel</p>
        </div>
        
        <div class="content">
            <div class="grid">
                <!-- Left Column: File Upload & Processing -->
                <div>
                    <div class="section">
                        <h3>üìÅ 1. Upload File Excel</h3>
                        <div class="form-group">
                            <label for="operation">Ch·ªçn lo·∫°i ph∆∞∆°ng tr√¨nh:</label>
                            <select id="operation">
                                <option value="H·ªá ph∆∞∆°ng tr√¨nh 2 ·∫©n">H·ªá ph∆∞∆°ng tr√¨nh 2 ·∫©n</option>
                                <option value="H·ªá ph∆∞∆°ng tr√¨nh 3 ·∫©n">H·ªá ph∆∞∆°ng tr√¨nh 3 ·∫©n</option>
                                <option value="H·ªá ph∆∞∆°ng tr√¨nh 4 ·∫©n">H·ªá ph∆∞∆°ng tr√¨nh 4 ·∫©n</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="version">Phi√™n b·∫£n m√°y t√≠nh:</label>
                            <select id="version">
                                <option value="fx799">fx-799MS</option>
                                <option value="fx800">fx-800MS</option>
                                <option value="fx801">fx-801MS</option>
                                <option value="fx802">fx-802MS</option>
                                <option value="fx803">fx-803MS</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="excelFile">Ch·ªçn file Excel (.xlsx/.xls):</label>
                            <input type="file" id="excelFile" accept=".xlsx,.xls">
                        </div>
                        
                        <button onclick="uploadFile()">üì§ Upload File</button>
                        <button onclick="downloadTemplate()" style="background: #4caf50;">üìã T·∫£i Template Excel</button>
                    </div>
                    
                    <div class="section">
                        <h3>‚ö° 2. X·ª≠ l√Ω d·ªØ li·ªáu</h3>
                        <button id="validateBtn" onclick="validateFile()" disabled>‚úÖ Ki·ªÉm tra c·∫•u tr√∫c file</button>
                        <button id="processBtn" onclick="processFile()" disabled>üöÄ X·ª≠ l√Ω & t·∫°o Keylog</button>
                        
                        <div id="progress" style="display: none;">
                            <div class="progress">
                                <div class="progress-bar" id="progressBar" style="width: 0%">0%</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Right Column: Results & Info -->
                <div>
                    <div class="section">
                        <h3>üìä Th√¥ng tin file</h3>
                        <div id="fileInfo"></div>
                    </div>
                    
                    <div class="section">
                        <h3>üìã K·∫øt qu·∫£</h3>
                        <div id="results"></div>
                    </div>
                </div>
            </div>
            
            <!-- Log Section -->
            <div class="section">
                <h3>üìù Log x·ª≠ l√Ω</h3>
                <div id="log" class="log"></div>
                <button onclick="clearLog()" style="width: auto; margin-top: 10px;">üóëÔ∏è X√≥a log</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:5000/api/equation';
        let uploadedFilePath = '';
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            logEntry.style.color = type === 'error' ? '#d32f2f' : type === 'success' ? '#388e3c' : '#666';
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        async function downloadTemplate() {
            try {
                const operation = document.getElementById('operation').value;
                log(`üìã ƒêang t·∫£i template cho: ${operation}`, 'info');
                
                const operationMap = {
                    'H·ªá ph∆∞∆°ng tr√¨nh 2 ·∫©n': 'he-2-an',
                    'H·ªá ph∆∞∆°ng tr√¨nh 3 ·∫©n': 'he-3-an',
                    'H·ªá ph∆∞∆°ng tr√¨nh 4 ·∫©n': 'he-4-an'
                };
                
                const url = `${API_BASE}/excel/template/${operationMap[operation]}`;
                const link = document.createElement('a');
                link.href = url;
                link.download = `template_${operationMap[operation]}.xlsx`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                log(`‚úÖ ƒê√£ t·∫£i template th√†nh c√¥ng!`, 'success');
                
            } catch (error) {
                log(`‚ùå L·ªói t·∫£i template: ${error.message}`, 'error');
            }
        }
        
        async function uploadFile() {
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];
            
            if (!file) {
                log('‚ùå Vui l√≤ng ch·ªçn file Excel!', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                log(`üì§ ƒêang upload file: ${file.name}`, 'info');
                
                const response = await fetch(`${API_BASE}/excel/upload`, {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    uploadedFilePath = result.data.filepath;
                    log(`‚úÖ Upload th√†nh c√¥ng!`, 'success');
                    
                    // Display file info
                    displayFileInfo(result.data.file_info);
                    
                    // Enable validation button
                    document.getElementById('validateBtn').disabled = false;
                    
                } else {
                    log(`‚ùå Upload th·∫•t b·∫°i: ${result.message}`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå L·ªói upload: ${error.message}`, 'error');
            }
        }
        
        function displayFileInfo(fileInfo) {
            const infoDiv = document.getElementById('fileInfo');
            infoDiv.innerHTML = `
                <div class="file-info">
                    <h4>üìÑ ${fileInfo.file_name}</h4>
                    <p><strong>S·ªë d√≤ng:</strong> ${fileInfo.total_rows.toLocaleString()}</p>
                    <p><strong>S·ªë c·ªôt:</strong> ${fileInfo.total_columns}</p>
                    <p><strong>K√≠ch th∆∞·ªõc:</strong> ${(fileInfo.file_size_mb || 0).toFixed(2)} MB</p>
                    <p><strong>C·ªôt c√≥ s·∫µn:</strong> ${fileInfo.columns.join(', ')}</p>
                </div>
            `;
        }
        
        async function validateFile() {
            if (!uploadedFilePath) {
                log('‚ùå Ch∆∞a c√≥ file ƒë·ªÉ ki·ªÉm tra!', 'error');
                return;
            }
            
            const operation = document.getElementById('operation').value;
            
            try {
                log(`üîç ƒêang ki·ªÉm tra c·∫•u tr√∫c file cho: ${operation}`, 'info');
                
                const response = await fetch(`${API_BASE}/excel/validate`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        filepath: uploadedFilePath,
                        operation: operation
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    const validation = result.data.validation_results;
                    
                    log(`‚úÖ Ki·ªÉm tra ho√†n t·∫•t!`, 'success');
                    log(`üìä D√≤ng c√≥ d·ªØ li·ªáu: ${validation.rows_with_data}/${validation.total_rows}`, 'info');
                    log(`‚ö†Ô∏è D√≤ng c√≥ l·ªói: ${validation.rows_with_errors}`, validation.rows_with_errors > 0 ? 'error' : 'info');
                    
                    if (validation.data_issues && validation.data_issues.length > 0) {
                        validation.data_issues.forEach(issue => {
                            log(`‚ùó D√≤ng ${issue.row}: ${issue.issues.join(', ')}`, 'error');
                        });
                    }
                    
                    if (validation.valid) {
                        document.getElementById('processBtn').disabled = false;
                        log(`üéâ File h·ª£p l·ªá, c√≥ th·ªÉ x·ª≠ l√Ω!`, 'success');
                    } else {
                        log(`‚ùå File kh√¥ng h·ª£p l·ªá: ${validation.missing_columns.join(', ')}`, 'error');
                    }
                    
                } else {
                    log(`‚ùå Ki·ªÉm tra th·∫•t b·∫°i: ${result.message}`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå L·ªói ki·ªÉm tra: ${error.message}`, 'error');
            }
        }
        
        async function processFile() {
            if (!uploadedFilePath) {
                log('‚ùå Ch∆∞a c√≥ file ƒë·ªÉ x·ª≠ l√Ω!', 'error');
                return;
            }
            
            const operation = document.getElementById('operation').value;
            const version = document.getElementById('version').value;
            
            try {
                log(`üöÄ ƒêang x·ª≠ l√Ω file v·ªõi ${operation} - ${version}`, 'info');
                
                // Show progress bar
                document.getElementById('progress').style.display = 'block';
                updateProgress(0, 'ƒêang kh·ªüi t·∫°o...');
                
                const response = await fetch(`${API_BASE}/excel/process`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        filepath: uploadedFilePath,
                        operation: operation,
                        version: version
                    })
                });
                
                updateProgress(100, 'Ho√†n t·∫•t!');
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    const data = result.data;
                    
                    log(`‚úÖ X·ª≠ l√Ω th√†nh c√¥ng!`, 'success');
                    log(`üìä ƒê√£ x·ª≠ l√Ω: ${data.processed_count} d√≤ng`, 'success');
                    log(`‚ùå L·ªói: ${data.error_count} d√≤ng`, data.error_count > 0 ? 'error' : 'info');
                    
                    // Show download link
                    displayResults(data);
                    
                } else {
                    log(`‚ùå X·ª≠ l√Ω th·∫•t b·∫°i: ${result.message}`, 'error');
                }
                
                // Hide progress bar after 2 seconds
                setTimeout(() => {
                    document.getElementById('progress').style.display = 'none';
                }, 2000);
                
            } catch (error) {
                log(`‚ùå L·ªói x·ª≠ l√Ω: ${error.message}`, 'error');
                document.getElementById('progress').style.display = 'none';
            }
        }
        
        function updateProgress(percent, message) {
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = percent + '%';
            progressBar.textContent = message || `${percent}%`;
        }
        
        function displayResults(data) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <div class="results">
                    <h4>üéâ X·ª≠ l√Ω ho√†n t·∫•t!</h4>
                    <p><strong>ƒê√£ x·ª≠ l√Ω:</strong> ${data.processed_count} d√≤ng</p>
                    <p><strong>L·ªói:</strong> ${data.error_count} d√≤ng</p>
                    <a href="${API_BASE}/excel/download/${data.output_file}" 
                       class="download-link" 
                       download="${data.output_file}">
                        üíæ T·∫£i file k·∫øt qu·∫£
                    </a>
                </div>
            `;
        }
        
        // Initialize
        log('üöÄ ConvertKeylogApp Equation Excel Mode ƒë√£ s·∫µn s√†ng!', 'success');
        log('üìã H∆∞·ªõng d·∫´n: Ch·ªçn lo·∫°i ph∆∞∆°ng tr√¨nh ‚Üí T·∫£i template ‚Üí Upload file Excel ‚Üí Ki·ªÉm tra ‚Üí X·ª≠ l√Ω', 'info');
    </script>
</body>
</html>